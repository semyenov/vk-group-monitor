<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VK Group Monitor Posts</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-200 text-slate-700 font-sans">
  <h1
    onclick="fetchPosts(); scrollToTop()"
    class="cursor-pointer max-w-4xl mx-auto hover:bg-slate-800 transition-colors duration-500 sticky top-0 z-50 px-4 py-3 bg-slate-700 border border-slate-500 text-slate-100 text-center font-semibold rounded-b-xl text-2xl font-bold mb-8 shadow-xl"
  >VK Group Monitor</h1>
  <div 
    id="posts" 
    class="max-w-3xl px-4 mx-auto"
  ></div>

  <script>
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        left: 0,
        behavior: "smooth",
      });
    }

    function toggleOriginal(el) {
      const original = el.parentElement.querySelector(".original");
      if (original) {
        original.classList.toggle("hidden");
      }
    }

    function copyToClipboard(el) {
      const text = el.textContent;
      const copied = el.parentElement.querySelector(".copied");

      copied.classList.remove("opacity-0");
      copied.classList.add("opacity-100");

      try {
        navigator.clipboard.writeText(text);
      } catch (err) {
        copied.classList.remove("opacity-100");
        copied.classList.add("opacity-0");
        console.error("Failed to copy: ", err);
        return;
      }

      setTimeout(() => {
        copied.classList.remove("opacity-100");
        copied.classList.add("opacity-0");
      }, 1000);
    }

    async function fetchPosts() {
      const postsDiv = document.getElementById("posts");

      const postsResponse = await fetch("/api/posts");
      const posts = await postsResponse.json();

      const groupsResponse = await fetch("/api/groups");
      const groups = await groupsResponse.json();

      function getGroupState(groupId) {
        return groups.data.find((state) => state.id === groupId);
      }

      function formatDate(date) {
        return new Date(date * 1000).toLocaleString();
      }

      if (posts.success) {
        posts.data.forEach((post) => {
          const groupState = getGroupState(post.groupId);
          const postDiv = document.createElement("div");
          postDiv.className = "border border-slate-300 rounded-lg mb-4 shadow relative";
          postDiv.innerHTML =
            `<h2 onclick="toggleOriginal(this)" class="cursor-pointer select-none text-slate-700 bg-slate-100 hover:bg-slate-50 hover:text-slate-500 transition-colors duration-500 py-4 px-4 rounded-t-lg relative z-10 w-full border-b border-slate-200 flex flex-row items-center justify-between gap-4">
              <img
                src="${groupState ? groupState.photo_50 : ""}"
                class="flex max-w-12 max-h-12 sm:max-w-8 sm:max-h-8 w-auto self-center rounded-full"
              />
              <div class="flex flex-1 flex-col sm:flex-row items-start justify-between sm:items-center gap-1">
                <div class="text-xl leading-tight font-bold uppercase">${groupState ? groupState.name : post.groupId}</div>
                <div class="text-nowrap px-2 py-1 rounded float-right text-xs text-slate-500 hover:text-slate-600 hover:bg-slate-100 font-semibold bg-white border border-slate-300 shadow-sm">
                  ${formatDate(post.date)}
                </div>  
              </div>
            </h2>
            <div class="original hidden py-4 px-4 border-b border-dashed border-slate-300 italic text-slate-500 bg-white bg-opacity-80">
              <p class="text-slate-700 mb-1 font-semibold text-sm">Оригинальный текст:</p>
              <p class="text-slate-400 text-xs">${post.original}</p>
            </div>
            <div onclick="copyToClipboard(this)" class="rewritten relative cursor-default py-4 px-4 bg-white bg-opacity-80 text-slate-700 rounded-md leading-tight relative z-10">
              ${post.rewritten}
              <div class="copied text-lg z-20 leading-none transition-opacity duration-300 flex justify-center items-center absolute top-0 right-0 left-0 bottom-0 bg-slate-200/40 filter backdrop-blur-sm opacity-0 pointer-events-none">
                <span class="px-6 py-4 bg-slate-200 uppercase border border-slate-300 text-slate-500 font-semibold shadow-sm bg-white rounded-md text-center">скопировано</span>
              </div>
            </div>`;

          postsDiv.appendChild(postDiv);
        });
      } else {
        postsDiv.innerHTML = `<p class="text-red-600 text-center">Error fetching posts: ${posts.error}</p>`;
      }
    }

    fetchPosts();
  </script>
</body>

</html>