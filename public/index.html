<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VK Group Monitor Posts</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconify -->
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  </head>

  <body class="bg-slate-200 text-slate-700" id="app">
    <h1
      @click="() => {
        fetchPosts();
        scrollToTop();
      }"
      class="cursor-pointer flex flex-row items-center justify-center max-w-4xl mx-auto hover:bg-slate-600 transition-colors duration-500 sticky top-0 z-50 py-4 bg-slate-700 border-b border-slate-400 text-center rounded-b-xl mb-6 shadow-2xl gap-4"
    >
      <div
        class="flex flex-row items-start justify-items-center flex-1 justify-center px-4 max-w-3xl mx-auto"
      >
        <div class="text-2xl font-bold text-white">VK Group Monitor</div>
        <div
          class="ml-2 font-sans text-xs text-slate-50 shadow-inner bg-slate-100/20 font-bold rounded-full px-2 py-1 leading-1"
        >
          {{ posts.length }}
        </div>
      </div>
    </h1>
    <div class="max-w-3xl px-4 mx-auto">
      <div
        v-for="post in posts"
        :key="post.id"
        class="border border-slate-300 rounded-lg mb-4 bg-slate-100 shadow-md relative"
      >
        <h2
          @click="toggleOriginal(post)"
          class="cursor-pointer select-none text-slate-700 bg-slate-100 hover:bg-slate-50 hover:text-slate-500 transition-colors duration-500 py-3 px-4 rounded-t-lg relative z-10 w-full flex flex-row items-center justify-between gap-4"
        >
          <img
            :src="getGroupState(post.groupId)?.photo_50 || ''"
            class="flex max-w-12 max-h-12 sm:max-w-8 sm:max-h-8 w-auto self-center rounded-full"
          />
          <div
            class="flex flex-1 flex-col items-start sm:flex-row sm:items-center justify-center sm:justify-between"
          >
            <div class="flex flex-1 font-bold uppercase">
              {{ getGroupState(post.groupId)?.name || post.groupId }}
            </div>
            <div
              class="inline-flex text-nowrap px-2 py-0.5 rounded float-right text-xs text-slate-500 hover:text-slate-600 hover:bg-slate-100 font-semibold bg-white border border-slate-300 shadow-sm"
            >
              {{ formatDate(post.date) }}
            </div>
          </div>
        </h2>
        <div
          v-if="post.showOriginal"
          class="original text-sm py-4 px-4 text-slate-500 bg-slate-100 rounded-b-lg"
        >
          <p class="text-slate-700 mb-1 font-semibold">Оригинальный текст:</p>
          <p class="text-slate-500 italic">{{ post.original }}</p>
        </div>
        <div
          @click="copyToClipboard(post.rewritten)"
          class="border-t border-dashed border-t-slate-200 rewritten relative cursor-default py-4 px-4 bg-white bg-opacity-80 text-slate-700 rounded-lg leading-tight relative z-10"
        >
          <pre class="font-sans text-sm whitespace-pre-wrap">
{{ post.rewritten }}</pre
          >
          <div
            v-if="post.copied"
            class="copied z-20 leading-none transition-opacity duration-300 flex justify-center items-center absolute top-0 right-0 left-0 bottom-0 bg-slate-200/40 filter backdrop-blur-sm rounded-lg"
          >
            <span
              class="px-3 uppercase py-1 bg-blue-200 border border-slate-400 text-slate-700 font-semibold shadow-sm bg-slate-100 rounded-md text-sm text-center"
              >текст скопирован</span
            >
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref } = Vue;

      const app = createApp({
        data() {
          return {
            posts: [],
            groups: [],
          };
        },
        methods: {
          scrollToTop() {
            window.scrollTo({
              top: 0,
              left: 0,
              behavior: "smooth",
            });
          },
          toggleOriginal(post) {
            post.showOriginal = !post.showOriginal;
          },
          async fetchPosts() {
            const postsResponse = await fetch("/api/posts");
            const posts = await postsResponse.json();

            const groupsResponse = await fetch("/api/groups");
            const groups = await groupsResponse.json();

            this.groups = groups.data;

            if (posts.success) {
              this.posts = posts.data.map((post) => ({
                ...post,
                showOriginal: false,
                copied: false,
              }));
            } else {
              this.posts = [{ error: posts.error }];
            }
          },
          getGroupState(groupId) {
            return this.groups.find((state) => state.id === groupId);
          },
          formatDate(date) {
            return new Date(date * 1000).toLocaleString();
          },
          copyToClipboard(text) {
            navigator.clipboard
              .writeText(text)
              .then(() => {
                const post = this.posts.find((p) => p.rewritten === text);
                if (post) {
                  post.copied = true;
                  setTimeout(() => {
                    post.copied = false;
                  }, 1000);
                }
              })
              .catch((err) => {
                console.error("Failed to copy: ", err);
              });
          },
        },
        mounted() {
          this.fetchPosts();
        },
      }).mount("#app");
    </script>
    <style>
      html {
        font-size: 14px;
      }
    </style>
  </body>
</html>
