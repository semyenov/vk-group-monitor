<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/favicon.ico" rel="icon">

  <title>VK Group Monitor Posts</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Iconify -->
  <script src="https://cdn.jsdelivr.net/npm/iconify-icon@2.1.0/dist/iconify-icon.min.js"></script>
  <!-- <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script> -->
  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3.5.11/dist/vue.global.js"></script>
</head>

<body class="font-sans bg-zinc-100 text-zinc-700">
  <div id="app">
    <h1
      class="sticky top-0 z-50 flex flex-row items-center justify-center gap-4 py-3 mx-auto mb-8 transition-colors duration-500 border-b shadow-lg cursor-pointer max-w-screen rounded-b-xl border-b-zinc-600 bg-zinc-800/95 shadow-zinc-400/40 backdrop-blur hover:text-zinc-50"
      @click="() => {
      fetchPosts()
      scrollToTop()
    }">
      <div class="flex flex-row items-center justify-between flex-1 max-w-3xl px-4 mx-auto">
        <div
          class="inline-flex flex-row items-stretch justify-center h-full mr-4 text-lg font-bold leading-none drop-shadow-zinc-100 text-zinc-50 drop-shadow-xl">
          <iconify-icon class="inline-flex h-full mr-2 text-zinc-200" icon="ion:logo-vk"></iconify-icon>
          <span class="text-zinc-50">Group Monitor</span>
        </div>
        <div
          class="inline-flex items-center justify-center px-1 py-1 text-sm font-bold leading-none transition-colors duration-300 border rounded-md shadow border-zinc-500 bg-zinc-700 shadow-zinc-800/20 hover:border-zinc-500/80 hover:bg-zinc-800">
          <span class="mx-1 text-zinc-100">{{ posts.length }}</span>
          <iconify-icon class="inline-flex text-zinc-100/80" icon="ion:newspaper-sharp"></iconify-icon>
        </div>
      </div>
    </h1>

    <div class="max-w-3xl px-4 mx-auto">
      <div class="relative pb-0 mb-6 rounded-lg shadow-lg bg-zinc-300/60 shadow-zinc-500/20" v-for="post in posts"
        :key="post.id">
        <div :class="{ 'max-h-36 overflow-hidden': !state.opened[post.id] }"
          class="relative z-30 pb-4 leading-tight border divide-y rounded-lg shadow-inner cursor-default divide-dashed divide-zinc-400/20 border-zinc-400/60 border-b-zinc-500/40 bg-zinc-50 text-zinc-600 shadow-zinc-300/60">
          <div @click="toggleOriginal(post.id)"
            class="flex flex-row items-center justify-center px-4 py-2 font-bold leading-none rounded-t-lg cursor-pointer text-md bg-zinc-100 sm:justify-between">
            <img
              class="flex self-center w-auto mr-3 border-2 rounded-full shadow max-w-12 sm:max-w-6 max-h-12 border-zinc-50 sm:max-h-6"
              :src="getGroup(post.groupId)?.photo_50 || ''">
            <div
              class="flex flex-col items-start justify-between flex-1 sm:flex-row sm:items-center sm:justify-between">
              <div class="flex flex-row items-center justify-start">
                <span class="inline-flex my-1 uppercase sm:my-0">
                  {{ getGroup(post.groupId)?.name || post.groupId }}
                </span>
              </div>
              <span
                class="inline-flex text-xs font-semibold rounded text-nowrap text-zinc-500 sm:mb-1 sm:border sm:border-zinc-200 sm:bg-zinc-100 sm:px-2 sm:py-1 sm:shadow-sm">
                {{ formatDate(post.date) }}
              </span>
            </div>
          </div>
          <div class="flex flex-col items-center justify-center w-full divide-y divide-dashed divide-zinc-200">
            <div v-if="state.opened[post.id]"
              class="flex flex-row items-center justify-start w-full px-4 pt-2 pb-1 text-xs bg-zinc-50">
              <span v-if="state.selected[post.id] !== 0" class="font-bold text-zinc-600">Вариант текста
                #{{state.selected[post.id] || post.rewritten.length - 1}}:</span>
              <span v-else class="font-bold text-zinc-600">Оригинальный
                текст:</span>
            </div>
            <post-component
              v-if="typeof post.rewritten[state.selected[post.id] || post.rewritten.length - 1] === 'object'"
              :post="post.rewritten[state.selected[post.id] !== undefined ? state.selected[post.id] : post.rewritten.length - 1]"
              class="w-full px-4 py-2 font-sans text-xs break-words whitespace-pre-wrap text-wrap"></post-component>
            <pre v-else
              class="w-full px-4 py-2 font-sans text-xs break-words whitespace-pre-wrap text-wrap">{{ post.rewritten[state.selected[post.id] !== undefined ? state.selected[post.id] : post.rewritten.length - 1] || 'Ошибка при получении текста' }}</pre>
          </div>
          <div v-if="post.attachments.photos.length > 0"
            class="flex flex-col items-start justify-start w-full divide-y divide-dashed divide-zinc-200">
            <div v-if="state.opened[post.id]"
              class="flex flex-row items-center justify-start w-full px-4 pt-2 pb-1 text-xs bg-zinc-50">
              <span class="font-bold text-zinc-600">Вложенные фото:</span>
            </div>
            <div v-for="photo in post.attachments.photos"
              class="flex flex-col items-start justify-center w-full px-4 py-2 text-xs border-zinc-300">
              <img class="flex w-full mb-2" :src="photo.url || ''" />
              <span class="inline-flex items-center justify-center text-xs text-zinc-500">
                <iconify-icon class="mr-1 text-zinc-500" icon="mdi:image-multiple"></iconify-icon>
                <span class="text-zinc-600">{{ photo.text || photo.id
                  }}</span>
              </span>
            </div>
          </div>
          <div v-if="post.attachments.links.length > 0"
            class="flex flex-col items-center justify-center w-full divide-y divide-dashed divide-zinc-200">
            <div v-if="state.opened[post.id]"
              class="flex flex-row items-center justify-start w-full px-4 pt-2 pb-1 text-xs bg-zinc-50">
              <span class="font-bold text-zinc-600">Вложенные ссылки:</span>
            </div>
            <a v-for="link in post.attachments.links"
              class="flex flex-row items-start justify-start w-full px-4 py-2 mb-2 text-xs border-zinc-300"
              target="_blank" :href="link.url">
              <iconify-icon class="mr-1 text-zinc-500" icon="mdi:link"></iconify-icon>
              <span class="text-zinc-600">{{ link.title }}</span>
            </a>

          </div>
          <div
            class="absolute top-0 bottom-0 left-0 right-0 z-20 flex items-center justify-center leading-none transition-opacity duration-300 rounded-lg shadow bg-zinc-200/40 filter backdrop-blur-sm"
            v-if="state.loading[post.id]">
            <span
              class="px-4 py-2 text-lg font-semibold leading-none text-center uppercase border rounded shadow-md border-zinc-200 bg-zinc-50 text-zinc-500">
              Генерация текста
            </span>
          </div>
        </div>

        <!-- Footer -->
        <div
          class="box-content relative flex flex-row flex-wrap items-stretch justify-between pt-2 -mt-3 text-xs border rounded-b-lg border-zinc-400/60 bg-zinc-100/80 text-zinc-500">
          <div class="flex flex-row flex-wrap leading-none uppercase divide-x flex-0 divide-zinc-300">
            <div class="flex items-center justify-start pt-2 pb-1 pl-4 pr-2 flex-0">
              <iconify-icon class="mr-1 text-zinc-500" icon="mdi:heart-outline"></iconify-icon>
              <span>{{ post.likesCount }}</span>
            </div>
            <div class="flex-0 flex items-center justify-start px-2 pb-1 pt-1.5">
              <iconify-icon class="mr-1 text-zinc-500" icon="mdi:share-outline"></iconify-icon>
              <span>{{ post.repostsCount }}</span>
            </div>
            <div class="flex-0 flex items-center justify-start px-2 pb-1 pt-1.5">
              <iconify-icon class="mr-1 text-zinc-500" icon="mdi:eye-outline"></iconify-icon>
              <span>{{ post.viewsCount }}</span>
            </div>
            <div class="flex-0 flex items-center justify-start px-2 pb-1 pt-1.5"
              v-if="post.attachments.photos.length > 0 || post.attachments.links.length > 0">
              <iconify-icon class="mr-1 text-zinc-500" icon="mdi:attachment"></iconify-icon>
              <span>{{ post.attachments.links.length +
                post.attachments.photos.length }}</span>
            </div>
          </div>
          <div
            class="right-0 flex flex-row items-stretch justify-end flex-1 w-full h-full overflow-hidden content-stretch">
            <div
              class="text-nowrap flex cursor-pointer items-center border-l border-zinc-300 px-2 pb-1 pt-1.5 font-semibold transition-colors duration-300 hover:bg-zinc-100/40"
              :class="{ 'bg-zinc-200 border-zinc-300': state.selected[post.id] !== undefined ? state.selected[post.id] === index : index === post.rewritten.length - 1 }"
              v-for="(rewrite, index) in post.rewritten" :key="index" @click="selectRewrite(post.id, index)">
              <span class="opacity-45">v</span>
              <span class="text-shadow=sm font-bold">{{ index }}</span>
            </div>
            <div
              class="flex items-center justify-center px-2 pt-2 pb-1 font-bold text-green-600 transition-colors duration-300 border-l rounded-br-lg cursor-pointer text-nowrap border-zinc-300 hover:bg-zinc-50"
              @click="fetchRewritePost(post.id)">
              <iconify-icon class="inline-flex text-xl" icon="ion:load-d"></iconify-icon>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, defineComponent } = Vue;

    const PostComponent = defineComponent({
      name: "post-component",
      props: {
        post: {
          type: Object,
          required: true,
        },
      },
      setup(props) {
        const {
          title,
          content,
          key_points,
          practical_advice,
          hashtags,
          source_link,
          visual_element,
          poll_question
        } = props.post;

        return {
          title,
          content,
          key_points,
          practical_advice,
          hashtags,
          source_link,
          visual_element,
          poll_question,
        }
      },
      template: `
        <div class="flex flex-col items-start justify-start gap-4">
          <div v-if="title" class="flex flex-col items-start justify-start gap-1">
            <!-- <span class="text-xs font-bold iconify-inline text-zinc-500">Заголовок:</span>  -->
            <h4 class="flex flex-col items-start mb-0 text-lg font-semibold leading-tight text-zinc-600">
              <span class="text-zinc-600">{{ title }}</span>
            </h4>
          </div>
          <div v-if="content" class="flex flex-col items-start justify-start gap-1">
            <span class="text-xs font-bold iconify-inline text-zinc-500">Контент:</span>
            <div class="flex flex-col items-start justify-start">
              <span class="text-zinc-600">{{ content }}</span>
            </div>
          </div>
          <div v-if="poll_question" class="flex flex-col items-start justify-start gap-1">
            <span class="text-xs font-bold iconify-inline text-zinc-500">Опрос:</span>
            <div class="flex flex-row items-center">
              <span class="text-zinc-600">{{ poll_question }}</span>
            </div>
          </div>
          <div class="flex flex-col items-start justify-start gap-1">
            <span class="text-xs font-bold iconify-inline text-zinc-500">Ключевые точки:</span>
            <div class="flex flex-col items-start w-full">
              <span v-for="key_point in key_points" class="text-zinc-600">{{ key_point }}</span>
            </div>
          </div>
          <div class="flex flex-col items-start justify-start gap-1">
            <span class="text-xs font-bold iconify-inline text-zinc-500">Практические советы:</span>
            <div class="flex flex-col items-start justify-start">
              <span class="text-zinc-600">{{ practical_advice }}</span>
            </div>
          </div>
          <div class="flex flex-col items-start justify-start gap-1">
            <span class="text-xs font-bold iconify-inline text-zinc-500">Хэштеги:</span>
            <div class="flex flex-col items-start justify-start">
              <span v-for="hashtag in hashtags" class="text-zinc-600">{{ hashtag }}</span>
            </div>
          </div>
          <div class="flex flex-col items-start justify-start gap-1">
            <span class="text-xs font-bold iconify-inline text-zinc-500">Ссылка:</span>
            <div class="flex flex-col items-start justify-start">
              <a target="_blank" :href="source_link" class="text-zinc-600">{{ source_link }}</a>
            </div>
          </div>
        </div>
      `,
    });

    const app = createApp({
      data() {
        return {
          posts: [],
          groups: [],
          state: {
            loading: {},
            opened: {},
            selected: {},
            position: {},
          },
        };
      },
      methods: {
        scrollToTop() {
          window.scrollTo({
            top: 0,
            left: 0,
            behavior: "smooth",
          });
        },
        toggleOriginal(postId) {
          this.state.opened[postId] = !this.state.opened[postId];
        },
        selectRewrite(postId, index) {
          this.state.selected[postId] = index;
        },
        async fetchRewritePost(postId) {
          this.state.loading[postId] = true;

          const postIndex = this.posts.findIndex((p) => p.id === postId);
          const postResponse = await fetch(`/api/posts/${postId}/rewrite`, {
            method: "POST",
            headers: [
              ["Content-Type", "application/json"],
            ]
          });

          const post = await postResponse.json();
          if (post.success) {
            this.posts[postIndex] = {
              ...this.posts[postIndex],
              rewritten: [
                this.posts[postIndex].original,
                ...post.data.rewritten
              ]
            };
            this.state.selected[postId] = post.data.rewritten.length;
          }

          this.state.loading[postId] = false;
        },
        async fetchPosts() {
          const postsResponse = await fetch("/api/posts");
          const posts = await postsResponse.json();

          const groupsResponse = await fetch("/api/groups");
          const groups = await groupsResponse.json();

          this.groups = groups.data;

          if (posts.success) {
            this.posts = posts.data.map((post) => ({
              ...post,
              rewritten: [
                post.original,
                ...post.rewritten
              ]
            }));
          } else {
            this.posts = [{ error: posts.error }];
          }
        },
        getGroup(groupId) {
          return this.groups.find((state) => state.id === groupId);
        },
        formatDate(date) {
          return new Date(date * 1000).toLocaleString();
        },
      },
      async mounted() {
        await this.fetchPosts();
      },
    })

    app.component('PostComponent', PostComponent)
    app.mount('#app')
  </script>
</body>

</html>