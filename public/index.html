<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VK Group Monitor Posts</title>

  <!-- Favicon -->
  <link rel="icon" href="/favicon.ico">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Iconify -->
  <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3.4.31/dist/vue.global.js"></script>
</head>

<body class="font-sans bg-zinc-200 text-zinc-700">
  <div id="app">
    <h1
      class="sticky top-0 z-50 flex flex-row items-center justify-center gap-4 py-3 mx-auto mb-8 transition-colors duration-500 border-b rounded-b-lg shadow-2xl cursor-pointer max-w-screen hover:text-zinc-50 bg-zinc-900/90 backdrop-blur border-b-zinc-900"
      @click="() => {
      fetchPosts()
      scrollToTop()
    }">
      <div class="flex flex-row items-center justify-between flex-1 max-w-3xl px-4 mx-auto">
        <div class="inline-flex flex-row h-full mr-4 text-2xl font-bold text-white">
          VK Group Monitor
        </div>
        <div
          class="inline-flex items-center justify-center p-1 box-content text-sm border-2 rounded-full min-w-5 bg-zinc-700 text-zinc-50 border-zinc-400 shadow-inner-lg font-bold">
          {{ posts.length }}
        </div>
      </div>
    </h1>


    <div class="max-w-3xl px-4 mx-auto">
      <div class="relative mb-6 rounded-lg bg-zinc-300 shadow-lg" v-for="post in posts" :key="post.id">

        <!-- Header -->
        <!-- <h4
          class="relative z-10 flex flex-row items-center justify-between px-4 py-2 text-sm transition-colors duration-500 rounded-t-lg cursor-pointer select-none text-zinc-100 bg-zinc-700">
          <img
            class="flex self-center w-auto mr-2 border-2 rounded-full shadow max-w-12 max-h-12 sm:max-w-6 sm:max-h-6 border-zinc-50"
            :src="getGroup(post.groupId)?.photo_50 || ''">
          <div class="flex flex-col items-start justify-center flex-1 sm:flex-row sm:items-center sm:justify-between">
            <div class="flex flex-1 py-1 font-bold leading-none uppercase">
              {{ getGroup(post.groupId)?.name || post.groupId }}
            </div>
            <div @click="toggleOriginal(post.id)"
              class="inline-flex float-right text-xs font-semibold text-nowrap sm:px-3 sm:py-1">
              {{ formatDate(post.date) }}
            </div>
          </div>
        </h4> -->

        <!-- Original -->
        <div class="z-20 text-sm border-b bg-zinc-100 border-x border-zinc-500 border-t -mb-1 rounded-t-lg border-dashed"
          v-if="state.opened[post.id]">
          <div
            @click="toggleOriginal(post.id)"
            class="py-3 px-4 cursor-pointer flex flex-row items-center justify-center sm:justify-between text-lg font-bold leading-none">
            <img
              class="flex self-center w-auto mr-2 border-2 rounded-full shadow max-w-12 max-h-12 sm:max-w-6 sm:max-h-6 border-zinc-50"
              :src="getGroup(post.groupId)?.photo_50 || ''">
            <div class="flex flex-1 flex-col sm:flex-row items-start justify-between sm:items-center sm:justify-between">
              <span class="inline-flex uppercase mb-1 sm:mb-0">{{ getGroup(post.groupId)?.name || post.groupId }}</span>
              <span
                class="inline-flex sm:float-right text-xs font-semibold sm:bg-zinc-200 text-zinc-600 text-nowrap sm:px-2 sm:py-1 sm:mb-1 sm:ml-2 sm:shadow-md rounded sm:border sm:border-zinc-400 cursor-pointer">
                {{ formatDate(post.date) }}
              </span>
            </div>
          </div>
          <pre
            class="px-4 pt-0 pb-6 italic text-zinc-600 text-xs break-words whitespace-pre-wrap text-wrap leading-1">{{ post.original }}</pre>
        </div>

        <!-- Rewrite -->

        <div
          class="relative z-30 leading-tight bg-zinc-50 border-b cursor-default border-x border-t border-zinc-400 text-zinc-800 rounded-lg shadow-md">
          <div v-if="!state.opened[post.id]"
            @click="toggleOriginal(post.id)"
            class="py-3 px-4 cursor-pointer flex flex-row items-center justify-center sm:justify-between text-lg font-bold leading-none">
            <img
              class="flex self-center w-auto mr-2 border-2 rounded-full shadow max-w-12 max-h-12 sm:max-w-6 sm:max-h-6 border-zinc-50"
              :src="getGroup(post.groupId)?.photo_50 || ''">
            <div class="flex flex-1 flex-col sm:flex-row items-start justify-between sm:items-center sm:justify-between">
              <span class="inline-flex uppercase mb-1 sm:mb-0">{{ getGroup(post.groupId)?.name || post.groupId }}</span>
              <span v-if="!state.opened[post.id]"
                class="inline-flex sm:float-right text-xs font-semibold sm:bg-zinc-200 text-zinc-600 text-nowrap sm:px-2 sm:py-1 sm:mb-1 sm:ml-2 sm:shadow-md rounded sm:border sm:border-zinc-400">
                {{ formatDate(post.date) }}
              </span>
            </div>
          </div>
          <pre
            :class="{ 'pt-6': state.opened[post.id] }"
            class="px-4 pt-0 pb-6 font-sans text-sm break-words whitespace-pre-wrap text-wrap">{{ post.rewritten[state.selected[post.id] !== undefined ? state.selected[post.id] : post.rewritten.length - 1] || 'Ошибка при получении текста' }}</pre>
          <div
            class="absolute top-0 bottom-0 left-0 right-0 z-20 flex items-center justify-center leading-none transition-opacity duration-300 rounded-lg shadow copied bg-zinc-200/40 filter backdrop-blur-sm"
            v-if="state.loading[post.id]">
            <span
              class="px-4 py-1 text-lg font-semibold text-center uppercase border rounded-lg shadow-md leading-1 bg-zinc-200 border-zinc-300 text-zinc-500 bg-zinc-100">
              Загрузка текста
            </span>
          </div>
        </div>
        <div
          class="flex flex-row justify-between items-center text-zinc-500 bg-zinc-300/40 rounded-b-lg border -mt-1 pt-1 border-zinc-400">
          <div class="text-xs flex items-center justify-start flex-1 pl-4 font-lighter leading-none uppercase">
            <span>{{ getGroup(post.groupId)?.name || post.groupId }}</span>
          </div>
          <div class="flex flex-row items-center justify-end">
            <div
              :class="{ 'bg-zinc-200 border-zinc-400 text-zinc-700': state.selected[post.id] !== undefined ? state.selected[post.id] === index : index === post.rewritten.length - 1 }"
              class="inline-flex border-l border-zinc-400 py-1 px-2 cursor-pointer float-right text-xs font-semibold text-nowrap font-bold"
              v-for="(rewrite, index) in post.rewritten" :key="index" @click="selectRewrite(post.id, index)">
              <span class="opacity-25">v</span>
              <span>{{ index + 1 }}</span>
            </div>
            <div
              class="inline-flex border-l border-zinc-400 bg-zinc-300 py-1 px-2 cursor-pointer hover:bg-zinc-300/50 float-right text-xs rounded-br-lg font-semibold text-nowrap"
              @click="fetchRewritePost(post.id)">
              <span class="h-4 w-4 iconify-inline text-zinc-700" data-icon="mdi:plus"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref } = Vue;

    const app = createApp({
      data() {
        return {
          posts: [],
          groups: [],
          state: {
            loading: {},
            opened: {},
            selected: {},
            position: {},
          },
        };
      },
      methods: {
        scrollToTop() {
          window.scrollTo({
            top: 0,
            left: 0,
            behavior: "smooth",
          });
        },
        toggleOriginal(postId) {
          this.state.opened[postId] = !this.state.opened[postId];
        },
        selectRewrite(postId, index) {
          this.state.selected[postId] = index;
        },
        async fetchRewritePost(postId) {
          this.state.loading[postId] = true;

          const postIndex = this.posts.findIndex((p) => p.id === postId);
          const postResponse = await fetch(`/api/posts/${postId}/rewrite`, {
            method: "POST",
            headers: [
              ["Content-Type", "application/json"],
            ]
          });

          const post = await postResponse.json();
          if (post.success) {
            this.posts[postIndex] = { ...this.posts[postIndex], ...post.data };
            this.state.selected[postId] = post.data.rewritten.length - 1;
          }

          this.state.loading[postId] = false;
        },
        async fetchPosts() {
          const postsResponse = await fetch("/api/posts");
          const posts = await postsResponse.json();

          const groupsResponse = await fetch("/api/groups");
          const groups = await groupsResponse.json();

          this.groups = groups.data;

          if (posts.success) {
            this.posts = posts.data.map((post) => ({
              ...post,
              showOriginal: false,
              copied: false,
            }));
          } else {
            this.posts = [{ error: posts.error }];
          }
        },
        getGroup(groupId) {
          return this.groups.find((state) => state.id === groupId);
        },
        formatDate(date) {
          return new Date(date * 1000).toLocaleString();
        },
      },
      async mounted() {
        await this.fetchPosts();
      },
    })
      .mount("#app");
  </script>
</body>

</html>