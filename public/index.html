<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VK Group Monitor Posts</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Iconify -->
  <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3.4.31/dist/vue.global.js"></script>
</head>

<body class="font-sans bg-slate-200/40">
  <div id="app">
    <h1
      class="sticky top-0 z-50 flex flex-row items-center justify-center py-3 mx-auto mb-6 transition-colors duration-500 border-b rounded-b-lg shadow-lg cursor-pointer shadow-slate-500/60 max-w-screen bg-slate-800/90 backdrop-blur-sm border-b-slate-600/50"
      @click="() => {
        fetchPosts()
        scrollToTop()
    }">
      <div class="flex flex-row items-start justify-center flex-1 max-w-3xl px-4 mx-auto ">
        <div class="flex flex-row h-full text-2xl font-normal text-slate-100">
          <span class="inline-flex mr-2">
            VK Group Monitor
          </span>
        </div>
        <div
          class="inline-flex items-center justify-center h-8 p-1 text-sm border rounded-full -md shadow-inner-lg min-w-8 bg-slate-200 text-slate-500 border-slate-400 shadow-slate-400/70">
          {{ posts.length }}
        </div>
      </div>
    </h1>
    <div class="max-w-3xl px-4 mx-auto">
      <div :class="post.showOriginal ? 'bg-slate-100/80' : 'bg-slate-200/60'"
        class="relative mb-6 border rounded-lg shadow-lg border-slate-400/70 shadow-slate-400/30" v-for="post in posts"
        :key="post.id">

        <!-- Header -->
        <h4
          class="relative z-10 flex flex-row items-center justify-between px-3 py-1 mb-0.5 transition-colors duration-500 rounded-lg cursor-pointer select-none text-slate-600 hover:text-slate-600/80"
          @click="toggleOriginal(post)">
          <img
            class="box-content flex self-center w-auto mr-2 border rounded-full shadow max-w-8 max-h-8 sm:max-w-5 sm:max-h-5 border-slate-100 shadow-inner-md shadow-slate-400"
            :src="getGroup(post.groupId)?.photo_50 || ''">
          <div class="flex flex-col items-start justify-center flex-1 sm:flex-row sm:items-center sm:justify-between">
            <div class="flex-1 text-xs font-bold leading-tight uppercase break-words">
              {{ getGroup(post.groupId)?.name || post.groupId }}
            </div>
            <div class="text-xs font-light rounded text-nowrap text-slate-500 hover:text-slate-600">
              {{ formatDate(post.date) }}
            </div>
          </div>
          </h2>

          <!-- Original -->
          <div
            class="z-20 px-4 pt-3 pb-4 -mx-1 text-xs text-sm border border-b-0 rounded-t-lg shadow-xl shadow-slate-400/60 original text-slate-500 bg-slate-100 border-slate-400/80"
            v-if="post.showOriginal">
            <p class="mb-1 font-semibold text-slate-600">Оригинальный текст:</p>
            <pre
              class="font-sans text-xs break-words whitespace-pre-wrap text-wrap italic text-slate-500">{{ post.original }}</pre>
          </div>

          <!-- Rewrite -->
          <div
            class="relative z-10 z-20 px-4 pt-3 pb-3 -mx-2 -mb-2 overflow-visible leading-tight border rounded-lg shadow-md cursor-default shadow-slate-300/60 bg-slate-100 border-slate-400/90 text-slate-700"
            @click="copyToClipboard(post)">
            <pre
              class="font-sans text-sm break-words whitespace-pre-wrap text-wrap">{{ post.rewritten || 'Ошибка при получении текста' }}</pre>
            <div
              class="absolute top-0 bottom-0 left-0 right-0 z-20 flex items-center justify-center leading-none transition-opacity duration-300 rounded-lg shadow-lg copied bg-slate-200/40 filter backdrop-blur-sm"
              v-if="post.copied">
              <span
                class="px-3 py-1 text-sm font-semibold text-center uppercase border rounded-md shadow-sm leading-1 bg-slate-200 border-slate-300 text-slate-500 bg-slate-100">
                текст скопирован
              </span>
            </div>
          </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref } = Vue;

    const app = createApp({
      data() {
        return {
          posts: [],
          groups: [],
        };
      },
      async mounted() {
        await this.fetchPosts();
      },
      methods: {
        scrollToTop() {
          window.scrollTo({
            top: 0,
            left: 0,
            behavior: "smooth",
          });
        },
        toggleOriginal(post) {
          post.showOriginal = !post.showOriginal;
        },
        async fetchPosts() {
          const postsResponse = await fetch("/api/posts");
          const posts = await postsResponse.json();

          const groupsResponse = await fetch("/api/groups");
          const groups = await groupsResponse.json();

          this.groups = groups.data;

          if (posts.success) {
            this.posts = posts.data.map((post) => ({
              ...post,
              showOriginal: false,
              copied: false,
            }));
          } else {
            this.posts = [{ error: posts.error }];
          }
        },
        getGroup(groupId) {
          return this.groups.find((state) => state.id === groupId);
        },
        formatDate(date) {
          return new Date(date * 1000).toLocaleString();
        },
        copyToClipboard(text) {
          if (navigator.clipboard) {
            navigator.clipboard
              .writeText(text)
              .then(() => {
                const post = this.posts.find((p) => p.rewritten === text);
                if (post) {
                  post.copied = true;
                  setTimeout(() => {
                    post.copied = false;
                  }, 1000);
                }
              })
              .catch((err) => {
                console.error("Failed to copy: ", err);
              });
          } else {
            alert("Your browser does not support clipboard");
          }
        },
      }
    });

    app.mount("#app");
  </script>
</body>

</html>